select * from(select row_number()OVER(ORDER BY a.ShippingDate) as FSeq,*,
ISNULL(a.SourceSalesProfit,case a.FBillTypeID when 3001 then (case a.Channel when '½è¾Æ' Then 0 when 'Ôù¾Æ' Then 0 Else(case a.Salesman when 'Vanessa' then 0 else (case when((a.Price-ISNULL(a.CompanyPrice,0)+ISNULL(a.FTT,0))*a.Qty) > 0 then ((a.Price-ISNULL(a.CompanyPrice,0)+ISNULL(a.FTT,0))* a.Qty) else 0 end) end )End) Else ((a.Price-ISNULL(a.CompanyPrice,0)+ISNULL(a.FTT,0))*a.Qty) End) as SalesProfit,
ISNULL(a.SourceRegionalProfit,case a.FBillTypeID when 3001 then (case a.Channel when '½è¾Æ' Then 0 when 'Ôù¾Æ' Then 0 Else (case a.Salesman when 'Vanessa' then ((a.Price-ISNULL(a.CompanyPrice,0)+ISNULL(a.FTT,0))*a.Qty) else 0 end )End) Else ((a.Price-ISNULL(a.CompanyPrice,0)+ISNULL(a.FTT,0))* a.Qty) End) as RegionalProfit from (select a.FBillNo as BillNo,CONVERT(varchar(100), a.FDate, 23) as ShippingDate,
case a.FBillTypeID when 3002 Then -FQty else FQty end as Qty,convert(decimal(18, 2),a.FPrice) as Price,
case a.FBillTypeID when 3002 Then -a.FAmount else a.FAmount end as SubTotal,a.FBillTypeID,
a.FItemID as MaterialId,b.FName as MaterialName,c.FName as CustName,d.FName as Salesman,b.FModel as Standard,ISNULL(c.Channel,'') as Channel,ISNULL(e.Remark,'') as Remark,ISNULL(e.FTT,ISNULL(f.FTT,0)) as FTT,ISNULL(e.Logistics,0) as LogisticsCosts,ISNULL(e.PackagingCosts,0) as PackagingCosts,ISNULL(e.OtherCosts,0) as OtherCosts,ISNULL(ISNULL(e.CompanyPrice,convert(decimal(18, 2),g.FXSLimitPrice)),0) as CompanyPrice,ISNULL(f.FTTCompensation,0) as FttCompensation,ISNULL(e.MHDEmp,'') as MHDEmp,e.RegionalProfit as SourceRegionalProfit,e.SalesProfit as SourceSalesProfit from 
(select FBillNo,FDate,FCustID,FItemID,FQty,FPrice,b.FAmount,FEmpID,b.FUnitID,b.FCostPrice,FBillTypeID from T_CC_StockBill a left join T_CC_StockBillEntry b on a.FID = b.FID where FClassTypeID = 1030002 And a.FDate >='2019-04-01' And a.FDate<='2019-04-30') a
 left join (select FItemID,FName,FModel,FCustom1,FCustom2 from t_ICItem) b on a.FItemID = b.FItemID left join (select a.FItemID,a.FName,c.FName as Channel from(select FItemID,FName,FParentID from t_item where FItemClassID = 1 and FLevel = 3)a left join (select FItemID,FName,FParentID from t_item where FItemClassID = 1 and FLevel = 2) b on a.FParentID = b.FItemID left join (select FItemID,FName,FParentID from t_item where FItemClassID = 1 and FLevel = 1) c on b.FParentID = c.FItemID) c on a.FCustID = c.FItemID left join (select FItemID,FName from t_Emp) d on a.FEmpID = d.FItemID left join t_nr_SalesCommissionRecord e on a.FBillNo = e.BillNo And a.FItemID = e.MaterialId and a.FQty = e.Qty left join (select * from t_nr_CompensationRecord where id in (select max(id) from t_nr_CompensationRecord group by CustName,MetraleId)) f on b.FItemID = f.MetraleId and c.FName = f.CustName left join T_ItemPrice g on b.FItemID = g.FItemID) a) a where BillNo = 'XSD20190400167'
